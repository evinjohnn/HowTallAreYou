<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HowTallAreYou? - AI Height Analysis</title>
    <style>
        /* --- Font Imports --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;800&display=swap');

        /* --- Base & Reset Styles --- */
        :root {
            --background: #f5f5f7;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --accent-blue: #0071e3;
            --card-background: rgba(255, 255, 255, 0.7);
            --border-color: rgba(0, 0, 0, 0.08);
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', -apple-system, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            margin: 0;
            overflow-x: hidden;
        }
        /* Clean Scrollbar */
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Header, Logo, and Usage Counter --- */
        .header-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem 2rem;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            pointer-events: none;
        }
        .logo { 
            display: flex; align-items: center; font-weight: 600;
            color: var(--text-primary); text-decoration: none;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: auto;
        }
        .logo.hidden { opacity: 0; transform: translateY(-10px); }
        .logo-image { height: 40px; margin-right: 0.5rem; }
        .website-name { font-size: 1.25rem; }

        .usage-counter {
            background-color: rgba(0, 0, 0, 0.05); color: var(--text-secondary); padding: 0.5rem 1rem;
            border-radius: 99px; font-size: 0.9rem; font-weight: 500;
            border: 1px solid var(--border-color);
            pointer-events: auto;
        }

        /* --- Main Content Sections --- */
        .content-wrapper { max-width: 1100px; margin: 0 auto; padding: 0 2rem; }
        .hero-section { display: flex; align-items: center; min-height: 100vh; padding: 6rem 0; box-sizing: border-box; }
        .left-content { flex: 1.1; display: flex; justify-content: center; }
        .right-content { flex: 0.9; display: flex; justify-content: center; perspective: 1500px; }
        .silhouette { max-width: 100%; max-height: 70vh; object-fit: contain; transform: rotateY(10deg); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .right-content:hover .silhouette { transform: scale(1.03) rotateY(0deg); }

        .content-box {
            background: var(--card-background);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 28px; padding: 2.5rem; width: 100%; max-width: 480px;
            box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.8);
        }
        h1 { font-size: 3rem; font-weight: 800; letter-spacing: -0.04em; margin: 0 0 0.75rem 0; }
        p { font-size: 1.1rem; color: var(--text-secondary); margin: 0 0 2rem 0; max-width: 45ch; line-height: 1.6; }
        
        /* --- Buttons & Previews --- */
        .action-button {
            display: flex; align-items: center; justify-content: center; width: 100%;
            padding: 1rem; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease; text-decoration: none;
        }
        #upload-btn { background-color: var(--accent-blue); color: white; }
        #upload-btn:hover { background-color: #007bf0; transform: scale(1.02); }
        
        #analyze-btn { background-color: #333; color: white; margin-top: 1rem; }
        #analyze-btn:disabled { background-color: #e8e8ed; color: var(--text-secondary); cursor: not-allowed; transform: none; }
        #analyze-btn:not(:disabled):hover { background-color: #444; transform: scale(1.02); }

        .image-preview-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-top: 1.5rem; }
        .uploaded-image-container { position: relative; aspect-ratio: 1/1; }
        .uploaded-image-container img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }
        .remove-image { position: absolute; top: -6px; right: -6px; background: #1d1d1f; color: white; border-radius: 50%; width: 24px; height: 24px; border: 2px solid white; cursor: pointer; display:flex; align-items:center; justify-content:center; }
        
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { color: #bf0a30; margin-top: 1rem; text-align: center; font-weight: 500;}

        /* --- Results & About Sections --- */
        .results-container, .about-container { padding: 6rem 2rem; }
        .results-container { display: none; max-width: 800px; margin: 0 auto; }
        .results-container h2, .about-container h2 { font-size: 2.5rem; font-weight: 700; text-align: center; margin-bottom: 3rem; }
        .report-box { background: white; border-radius: 20px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 16px rgba(0,0,0,0.05); }
        .report-box h3 { margin: 0 0 1rem 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .report-box p { font-size: 1rem; color: var(--text-primary); margin: 0; }
        .visualization-box canvas { width: 100%; height: auto; border-radius: 12px; max-height: 500px; object-fit: contain; background-color: #e8e8ed;}
        #reset-btn { margin: 2.5rem auto 0 auto; display: block; background: #333; color: white; }

        .about-container { border-top: 1px solid #d2d2d7; background-color: #fff; }
        .about-wrapper { display: flex; max-width: 800px; margin: 0 auto; gap: 3rem; align-items: flex-start; }
        .about-left-column { flex: 1; }
        .about-right-column { flex: 2; }
        .about-left-column h2 { text-align: left; margin: 0; }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
        .about-right-column h3 { font-size: 1.25rem; font-weight: 600; margin: 0 0 0.5rem 0; }
        .about-right-column p { font-size: 1rem; max-width: 60ch; }
        .about-button { background-color: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 100px; font-size: 1rem; font-weight: 500; cursor: pointer; margin-top: 1rem; text-decoration: none; display: inline-block; }
        
        /* --- Responsive Design --- */
        @media (max-width: 900px) {
            .right-content { display: none; }
            .left-content { justify-content: center; }
            .hero-section { padding-top: 8rem; min-height: 90vh; }
            .about-wrapper { flex-direction: column; }
            .about-left-column h2 { text-align: center; margin-top: 1rem;}
        }
        @media (max-width: 768px) {
            .header-container { padding: 1rem; }
            .logo-image { height: 32px; }
            .website-name { font-size: 1rem; }
            .usage-counter { padding: 6px 12px; font-size: 0.8rem; }
            .content-box { padding: 2rem; }
            h1 { font-size: 2.5rem; }
            p { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <div class="header-container">
        <a href="/" class="logo" id="logo">
            <img src="/src/2.jpg-removebg-preview.png" class="logo-image" alt="Logo">
            <span class="website-name">HowTallAreYou?</span>
        </a>
        <div class="usage-counter" id="usage-counter">
            <span id="usage-count">--</span> uses left this hour
        </div>
    </div>

    <div id="page-content">
        <main id="landing-page" class="hero-section">
            <div class="container">
                <div class="left-content">
                    <div class="content-box">
                        <h1>Stop Capping.</h1>
                        <p>Our AI provides a forensic-level height analysis. Upload up to 4 images for the most accurate, fused estimation.</p>
                        <input type="file" id="image-upload" accept="image/*" multiple style="display: none;">
                        <button id="upload-btn" class="action-button">Select Images</button>
                        <div id="image-preview-container" class="image-preview-container"></div>
                        <div id="error-message" class="error-message" style="display:none;"></div>
                        <button id="analyze-btn" class="action-button" disabled>
                            <span class="btn-text">Analyze Height</span>
                        </button>
                    </div>
                </div>
                <div class="right-content">
                    <img src="/src/4.png" alt="Silhouette" class="silhouette">
                </div>
            </div>
        </main>

        <section id="results-page" class="results-container">
            <h2>Analysis Report</h2>
            <div class="report-box visualization-box"><h3>AI Analysis Visualization</h3><canvas id="analysis-canvas"></canvas></div>
            <div class="report-box"><h3>Final Estimation</h3><p id="report-estimation">---</p></div>
            <div class="report-box"><h3>Methodology</h3><p id="report-methodology">---</p></div>
            <div class="report-box"><h3>Posture Correction</h3><p id="report-posture">---</p></div>
            <div class="report-box"><h3>Confidence Score</h3><p id="report-confidence">---</p></div>
            <div class="report-box"><h3>Caveats & Limitations</h3><p id="report-caveats">---</p></div>
            <button id="reset-btn" class="action-button">Analyze Another Photo</button>
        </section>

        <section class="about-container" id="about-section">
            <div class="content-wrapper">
                <div class="about-wrapper">
                    <div class="about-left-column">
                        <img src="/src/profile.jpg" alt="Evin John" class="profile-pic">
                        <h2>About the Creator</h2>
                    </div>
                    <div class="about-right-column">
                        <h3>Evin John</h3>
                        <p>I built this tool to explore the intersection of computer vision, advanced AI reasoning, and minimalist web design. My passion is turning complex technology into simple, powerful experiences.</p>
                        <p style="color: #4a4a4a;">This project uses a two-stage AI pipeline: Microsoft Azure for initial object detection and Google's Gemini as a reasoning engine to perform photogrammetry.</p>
                        <a href="https://www.linkedin.com/in/evinjohn" target="_blank" rel="noopener noreferrer" class="about-button">Connect on LinkedIn</a>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const usageCountSpan = document.getElementById('usage-count');
        const logo = document.getElementById('logo');
        const imageUploadInput = document.getElementById('image-upload');
        const uploadBtn = document.getElementById('upload-btn');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const analyzeBtn = document.getElementById('analyze-btn');
        const errorMessageDiv = document.getElementById('error-message');
        const landingPage = document.getElementById('landing-page');
        const resultsPage = document.getElementById('results-page');
        const aboutSection = document.getElementById('about-section');
        const resetBtn = document.getElementById('reset-btn');

        let uploadedImages = [];
        const MAX_IMAGES = 4;
        
        async function fetchUsage() {
            try {
                const response = await fetch('/api/usage');
                const data = await response.json();
                usageCountSpan.textContent = response.ok ? data.remaining : 'Error';
                if(analyzeBtn) {
                    const hasImages = uploadedImages.length > 0;
                    analyzeBtn.disabled = data.remaining <= 0 || !hasImages;
                }
            } catch (error) {
                console.error('Failed to fetch usage count:', error);
                usageCountSpan.textContent = 'N/A';
            }
        }
        fetchUsage();
        setInterval(fetchUsage, 60000);
        
        window.addEventListener('scroll', () => {
            logo.classList.toggle('hidden', window.scrollY > 30);
        });

        uploadBtn.addEventListener('click', () => imageUploadInput.click());
        imageUploadInput.addEventListener('change', handleImageUpload);
        analyzeBtn.addEventListener('click', handleAnalysis);
        resetBtn.addEventListener('click', showLandingPageUI);

        function handleImageUpload(event) {
            const files = Array.from(event.target.files).slice(0, MAX_IMAGES);
            uploadedImages = [];
            let loadedCount = 0;
            if(files.length === 0) { updateImagePreview(); return; }
            
            files.forEach(file => {
                if (!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImages.push(e.target.result);
                    loadedCount++;
                    if (loadedCount === files.length) {
                        updateImagePreview();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function updateImagePreview() {
            imagePreviewContainer.innerHTML = '';
            uploadedImages.forEach((image, index) => {
                imagePreviewContainer.innerHTML += `<div class="uploaded-image-container"><img src="${image}" alt="Preview ${index + 1}"><button class="remove-image" data-index="${index}">×</button></div>`;
            });
            document.querySelectorAll('.remove-image').forEach(button => {
                button.addEventListener('click', (e) => removeImage(parseInt(e.target.dataset.index, 10)));
            });
            fetchUsage();
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
        }

        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.style.display = 'block';
        }

        function hideError() {
            errorMessageDiv.style.display = 'none';
        }

        function toggleLoading(isLoading) {
            analyzeBtn.disabled = isLoading;
            analyzeBtn.innerHTML = isLoading ? `<div class="spinner"></div>` : `<span class="btn-text">Analyze Height</span>`;
        }

        async function handleAnalysis() {
            hideError();
            if (uploadedImages.length === 0) { alert('Please upload at least one image.'); return; }
            toggleLoading(true);

            try {
                const response = await fetch('/api/analyze', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ images: uploadedImages }) 
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'API request failed');
                
                showResultsPageUI(data);
                fetchUsage();
            } catch (error) {
                console.error("Analysis Error:", error);
                showError(`Analysis Failed: ${error.message}`);
                toggleLoading(false);
                fetchUsage();
            }
        }

        function showResultsPageUI(report) {
            landingPage.style.display = 'none';
            aboutSection.style.display = 'none';
            resultsPage.style.display = 'block';
            window.scrollTo(0, 0);
            
            document.getElementById('report-estimation').textContent = report.estimation || "---";
            document.getElementById('report-methodology').textContent = report.methodology || "---";
            document.getElementById('report-posture').textContent = report.postureCorrection || "---";
            document.getElementById('report-confidence').textContent = report.confidenceScore || "---";
            document.getElementById('report-caveats').textContent = report.caveats || "---";

            const viz = report.visualizationData;
            if (viz && viz.sourceImageIndex !== undefined && uploadedImages[viz.sourceImageIndex]) {
                const sourceImage = new Image();
                sourceImage.src = uploadedImages[viz.sourceImageIndex];
                
                sourceImage.onload = () => {
                    const canvas = document.getElementById('analysis-canvas');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    canvas.width = sourceImage.naturalWidth;
                    canvas.height = sourceImage.naturalHeight;
                    ctx.drawImage(sourceImage, 0, 0);

                    const drawBox = (box, color, label) => {
                        if(!box) return;
                        ctx.strokeStyle = color;
                        ctx.lineWidth = Math.max(4, sourceImage.naturalWidth * 0.005);
                        ctx.strokeRect(box.x, box.y, box.w, box.h);
                        ctx.fillStyle = color;
                        ctx.font = `bold ${Math.max(16, sourceImage.naturalWidth * 0.02)}px Poppins`;
                        ctx.fillText(label, box.x, box.y - 10);
                    };
                    drawBox(viz.personBox, '#0071e3', 'Subject');
                    drawBox(viz.referenceBox, '#FF3B30', 'Reference');
                };
            }
        }

        function showLandingPageUI() {
            resultsPage.style.display = 'none';
            landingPage.style.display = 'block';
            aboutSection.style.display = 'block';
            hideError();
            imageUploadInput.value = '';
            uploadedImages = [];
            updateImagePreview();
            toggleLoading(false);
        }
    });
    </script>
</body>
</html>